<script lang="ts">
	import { startTone, toneFor, type ToneContext } from "$lib/tone";
	import { sleep, telephone, type Key } from "$lib";
	import { playSegments } from "$lib/playback";
	import type { MenuNode } from "$lib/nodes";
	import { homeNode } from "$lib/nodes";
	import { onMount } from "svelte";
	import "$lib/global.scss";
	import "greset";

	let recording: Promise<Blob | null>;
	let tone: ToneContext | undefined;
	let aborter: AbortController;
	let node: MenuNode | null;
	let stream: MediaStream;
	let number = "";

	onMount(async () => {
		stream = await navigator.mediaDevices.getUserMedia({ audio: true });
	});

	async function press(key: Key) {
		number += key.toString();
		tone = startTone(key);

		if (node) {
			let next = await node.press(key, () => {
				aborter?.abort();
				return recording;
			});

			if (next === null) return;

			// Cleanup previous node
			aborter?.abort();

			loadNode(next);
		}
	}

	async function hangup() {
		aborter?.abort();

		if (node?.hangup) node.hangup(recording);

		number = "";
		node = null;

		for (let i = 0; i < 3; i++) {
			await toneFor(1, 100);
			await sleep(75);
		}
	}

	async function call() {
		if (node) return; // Exit if already called
		aborter = new AbortController();

		if (!telephone.startsWith(number)) number = "";
		for (let i = number.length; i < telephone.length; i++) {
			if (aborter.signal.aborted) return;
			const key = Number(telephone.charAt(i)) as Key;
			number += key;

			await toneFor(key, 75);
			await sleep(50);
		}

		await sleep(250);
		loadNode(homeNode);
	}

	function loadNode(n: MenuNode) {
		// Load new node
		aborter = new AbortController();
		node = n;

		recording = new Promise(async (resolve) => {
			await playSegments(n.segments, aborter);
			if (aborter.signal.aborted) resolve(null);

			const recorder = new MediaRecorder(stream);
			const chunks: BlobPart[] = [];

			recorder.addEventListener("dataavailable", (e) => {
				chunks.push(e.data);
			});

			recorder.start();

			aborter.signal.addEventListener("abort", () => recorder.stop());

			recorder.addEventListener("stop", async () => {
				const blob = new Blob(chunks, { type: "audio/ogg; codecs=opus" });
				resolve(blob);
			});
		});
	}

	const stopTone = () => tone?.stop();
</script>

<svelte:window on:blur={stopTone} on:pagehide={stopTone} on:pointerup={stopTone} />

<svg
	on:touchstart|nonpassive|preventDefault
	xmlns="http://www.w3.org/2000/svg"
	viewBox="0 0 700 1648"
	fill="none"
>
	<path
		fill="#363A40"
		d="M36 105c13.5-69.5 47.5-65 76.5-79S341 0 341 0s211.5 8.5 240 21 53.5 14.5 74.5 84 39 343.5 44 587-32 817.5-44.5 848-11 85-101.5 92.5-197 15.5-197 15.5-114-6.5-199.5-15.5-85-43-97.5-92.5S0 895.5 1 692s21.5-517.5 35-587Z"
	/><path
		fill="#BEB9A0"
		d="M346 1.5S521.5 3.714 569.5 22s48 56 48 56S669 320 671 557.5 611 897 611 897s-83 183.5-263 176.5S101 921.5 86.5 902 15 829 21 557.5 73.5 78 73.5 78s4-16 22.5-40S346 1.5 346 1.5V14c-35 2.5-194.5 13-215 35.5S110 78 110 78 57.5 215.5 66 509.5s112.5 360 121 364 66-23.5 161-23 160.5 17 170 23 125.5-98.5 112.5-364-43-422-43-422-1.5-11-20.5-38S346 14 346 14V1.5Z"
	/><path
		fill="#6B8757"
		d="M349.5 421c148.5.5 234.5 3 241.5 10.5s11 40.5 7 172-2 166-13.5 169.5-86.5 12-235 13-222.5-2-228.5-7-20.5-33.5-20.5-153-6-180 0-188 100.5-17.5 249-17Z"
	/><rect width="218" height="49" x="235" y="310" fill="#2F2E27" rx="7" /><path
		fill="#26292F"
		d="M345.001 31.5s22 1 20.5 111.5-20.5 112-20.5 112-24.5-1.5-23.5-112 23.5-111.5 23.5-111.5Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(1)}
		d="M164 1084.5c23 8.5 54.75 32 48.5 57s-59 14.5-84.5 8-53-37-43.5-61 56.5-12.5 79.5-4Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M152.955 1094.45V1141h-11.228v-36.05h-.272l-10.41 6.37v-9.73l11.478-7.14h10.432Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(3)}
		d="M547.299 1080.34c-23 8.5-54.75 32-48.5 57s59 14.5 84.5 8 53-37 43.5-61-56.5-12.5-79.5-4Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M563.136 1135.64c-3.545 0-6.689-.61-9.431-1.82-2.728-1.23-4.879-2.92-6.455-5.07-1.576-2.15-2.379-4.63-2.409-7.43h11.318c.046 1.01.371 1.91.977 2.7.606.78 1.432 1.38 2.478 1.82 1.045.44 2.234.66 3.568.66 1.333 0 2.507-.23 3.523-.7 1.03-.49 1.833-1.15 2.409-1.98.575-.85.856-1.82.841-2.91.015-1.09-.296-2.06-.932-2.91-.637-.85-1.538-1.51-2.705-1.98-1.151-.47-2.515-.7-4.091-.7h-4.522v-8h4.522c1.379 0 2.591-.23 3.637-.68 1.06-.46 1.886-1.09 2.477-1.91.591-.84.879-1.79.864-2.87.015-1.04-.235-1.96-.75-2.75-.5-.8-1.205-1.42-2.114-1.86-.894-.44-1.932-.66-3.114-.66-1.242 0-2.371.22-3.386.66-1 .44-1.796 1.06-2.386 1.86-.591.81-.902 1.74-.932 2.8h-10.75c.03-2.77.803-5.21 2.318-7.32 1.515-2.12 3.576-3.78 6.182-4.98 2.621-1.19 5.606-1.79 8.954-1.79 3.334 0 6.265.58 8.796 1.75 2.53 1.16 4.5 2.76 5.909 4.77 1.409 2 2.113 4.27 2.113 6.8.016 2.62-.84 4.78-2.568 6.47-1.712 1.7-3.916 2.75-6.613 3.14v.36c3.606.43 6.325 1.59 8.159 3.5 1.848 1.91 2.765 4.3 2.75 7.16 0 2.7-.796 5.09-2.387 7.18-1.575 2.08-3.772 3.72-6.591 4.91-2.803 1.19-6.022 1.78-9.659 1.78Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(6)}
		d="M539.299 1196.34c-23 8.5-54.75 32-48.5 57s59 14.5 84.5 8 53-37 43.5-61-56.5-12.5-79.5-4Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M558.091 1254.64c-2.546 0-4.985-.41-7.318-1.23-2.334-.83-4.409-2.15-6.228-3.96-1.818-1.81-3.25-4.19-4.295-7.13-1.045-2.96-1.561-6.55-1.545-10.8.015-3.83.484-7.27 1.409-10.32.924-3.06 2.242-5.65 3.954-7.79 1.727-2.14 3.788-3.77 6.182-4.89 2.409-1.13 5.098-1.7 8.068-1.7 3.258 0 6.129.63 8.614 1.91 2.5 1.25 4.5 2.95 6 5.09 1.5 2.12 2.386 4.48 2.659 7.09h-11.068c-.334-1.47-1.068-2.58-2.205-3.34-1.121-.77-2.454-1.16-4-1.16-2.848 0-4.977 1.23-6.386 3.7-1.394 2.47-2.106 5.78-2.137 9.91h.296a10.116 10.116 0 0 1 2.75-3.59c1.197-1 2.568-1.76 4.114-2.29 1.56-.55 3.212-.82 4.954-.82 2.788 0 5.25.64 7.386 1.93 2.137 1.29 3.811 3.05 5.023 5.3 1.212 2.22 1.811 4.78 1.796 7.65.015 3.25-.743 6.11-2.273 8.6-1.53 2.47-3.652 4.39-6.364 5.77-2.697 1.38-5.825 2.07-9.386 2.07Zm-.068-8.64c1.379 0 2.613-.33 3.704-.98a6.981 6.981 0 0 0 2.568-2.66c.622-1.12.925-2.38.91-3.79.015-1.43-.288-2.69-.91-3.8a6.874 6.874 0 0 0-2.545-2.63c-1.076-.66-2.311-.98-3.705-.98-1.015 0-1.962.19-2.84.57-.879.38-1.644.91-2.296 1.59a7.234 7.234 0 0 0-1.5 2.36 8 8 0 0 0-.568 2.91c.015 1.38.333 2.63.954 3.75a7.172 7.172 0 0 0 2.546 2.68c1.076.65 2.303.98 3.682.98Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(9)}
		d="M529.299 1317.34c-23 8.5-54.75 32-48.5 57s59 14.5 84.5 8 53-37 43.5-61-56.5-12.5-79.5-4Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M545.955 1325.82c2.545 0 4.977.41 7.295 1.25 2.318.82 4.386 2.13 6.205 3.93 1.818 1.79 3.25 4.14 4.295 7.07 1.045 2.92 1.568 6.49 1.568 10.7.015 3.88-.439 7.36-1.363 10.43-.925 3.07-2.25 5.67-3.978 7.82-1.712 2.15-3.772 3.8-6.182 4.93-2.409 1.13-5.098 1.69-8.068 1.69-3.272 0-6.159-.63-8.659-1.89-2.485-1.27-4.477-2.98-5.977-5.14-1.485-2.15-2.371-4.56-2.659-7.22H539.5c.348 1.54 1.083 2.71 2.205 3.5 1.121.77 2.462 1.16 4.022 1.16 2.849 0 4.978-1.24 6.387-3.71 1.409-2.47 2.113-5.82 2.113-10.07h-.272a10.276 10.276 0 0 1-2.773 3.59c-1.182 1-2.553 1.77-4.114 2.3-1.56.53-3.204.79-4.932.79-2.788 0-5.25-.63-7.386-1.9-2.121-1.28-3.788-3.03-5-5.25-1.197-2.23-1.803-4.78-1.818-7.64-.015-3.21.735-6.05 2.25-8.5 1.515-2.47 3.629-4.39 6.341-5.77 2.712-1.4 5.856-2.09 9.432-2.07Zm.068 8.63c-1.394 0-2.637.33-3.728.98a7.058 7.058 0 0 0-2.545 2.64c-.621 1.1-.924 2.35-.909 3.73.015 1.37.326 2.62.932 3.72a7.114 7.114 0 0 0 2.522 2.64c1.076.65 2.303.98 3.682.98 1.031 0 1.985-.19 2.864-.57a7.07 7.07 0 0 0 2.295-1.57 7.456 7.456 0 0 0 1.523-2.36c.379-.9.561-1.85.546-2.87-.016-1.35-.334-2.57-.955-3.68a7.07 7.07 0 0 0-2.568-2.64c-1.076-.66-2.296-1-3.659-1Z"
	/><path
		fill="#DCD8C9"
		d="M526.299 1433.34c-23 8.5-54.75 32-48.5 57s59 14.5 84.5 8 53-37 43.5-61-56.5-12.5-79.5-4Z"
	/><path
		fill="#414A3C"
		d="m543.25 1489 7.636-46.55h8.182l-7.636 46.55h-8.182Zm-20.75-11.09 1.386-8.18h36.909l-1.386 8.18H522.5Zm4.386 11.09 7.637-46.55h8.182l-7.637 46.55h-8.182Zm-1.727-27.27 1.386-8.18h36.91l-1.387 8.18h-36.909Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(4)}
		d="M175.422 1205.34c23 8.5 54.75 32 48.5 57s-59 14.5-84.5 8-53-37-43.5-61 56.5-12.5 79.5-4Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M136.864 1254.27v-8.77l19.068-30.05h7.795v11.91h-4.522l-11.16 17.69v.36h27.614v8.86h-38.795Zm22.477 7.73v-10.41l.227-3.84v-32.3h10.523V1262h-10.75Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(7)}
		d="M182.422 1321.34c23 8.5 54.75 32 48.5 57s-59 14.5-84.5 8-53-37-43.5-61 56.5-12.5 79.5-4Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="m153.409 1378 18.773-37.18v-.3h-21.955v-9.07h33.591v9.14L164.977 1378h-11.568Z"
	/><path
		fill="#DCD8C9"
		d="M188.422 1437.34c23 8.5 54.75 32 48.5 57s-59 14.5-84.5 8-53-37-43.5-61 56.5-12.5 79.5-4Z"
	/><path
		fill="#414A3C"
		d="m165.409 1482.64.659-8.41-7 4.79-3.341-5.86 7.591-3.61-7.591-3.62 3.341-5.86 7 4.79-.659-8.41h6.705l-.659 8.41 7-4.79 3.34 5.86-7.59 3.62 7.59 3.61-3.34 5.86-7-4.79.659 8.41h-6.705Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(2)}
		d="M354.03 1105.5c66.5 1 70.361 22 70 28.5-.361 6.5-13.5 49-70 47.5s-70.5-38.5-71-47.5 4.5-29.5 71-28.5Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M338.462 1163v-8.09l16.977-14.86c1.273-1.16 2.356-2.21 3.25-3.16.894-.97 1.576-1.94 2.046-2.91.469-.99.704-2.06.704-3.21 0-1.29-.28-2.38-.841-3.29a5.604 5.604 0 0 0-2.318-2.14c-.985-.5-2.114-.75-3.386-.75-1.288 0-2.417.27-3.387.8a5.45 5.45 0 0 0-2.272 2.25c-.531.98-.796 2.18-.796 3.59H337.78c0-3.17.712-5.9 2.136-8.21 1.425-2.3 3.425-4.07 6-5.32 2.591-1.25 5.599-1.88 9.023-1.88 3.53 0 6.599.59 9.205 1.77 2.606 1.18 4.621 2.83 6.045 4.96 1.44 2.1 2.159 4.55 2.159 7.34 0 1.77-.356 3.53-1.068 5.27-.712 1.74-1.992 3.67-3.841 5.77-1.833 2.11-4.439 4.63-7.818 7.57l-5.568 5.14v.29h18.863v9.07h-34.454Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(5)}
		d="M354.03 1220.5c66.5 1 70.361 22 70 28.5-.361 6.5-13.5 49-70 47.5s-70.5-38.5-71-47.5 4.5-29.5 71-28.5Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M356.25 1282.64c-3.394 0-6.409-.62-9.045-1.84-2.637-1.23-4.72-2.92-6.25-5.07-1.516-2.15-2.303-4.62-2.364-7.41H349.5c.091 1.71.788 3.09 2.091 4.13 1.303 1.03 2.856 1.55 4.659 1.55 1.409 0 2.659-.31 3.75-.93a6.607 6.607 0 0 0 2.568-2.62c.621-1.13.924-2.43.909-3.9.015-1.5-.295-2.82-.932-3.94a6.602 6.602 0 0 0-2.59-2.61c-1.091-.64-2.349-.95-3.773-.95a8.27 8.27 0 0 0-3.841.88c-1.197.61-2.106 1.43-2.727 2.48l-9.932-1.86 2.023-25.1h29.863v9.07h-20.613l-1.069 10.98h.273c.773-1.29 2.015-2.35 3.727-3.18 1.728-.85 3.69-1.27 5.887-1.27 2.788 0 5.272.65 7.454 1.95 2.197 1.29 3.925 3.08 5.182 5.36 1.273 2.29 1.909 4.91 1.909 7.87 0 3.19-.757 6.03-2.273 8.5-1.5 2.47-3.606 4.41-6.318 5.82-2.697 1.39-5.856 2.09-9.477 2.09Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(8)}
		d="M354.03 1340.5c66.5 1 70.361 22 70 28.5-.361 6.5-13.5 49-70 47.5s-70.5-38.5-71-47.5 4.5-29.5 71-28.5Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M356.614 1402.64c-3.622 0-6.856-.58-9.705-1.73-2.833-1.17-5.061-2.74-6.682-4.73-1.606-2-2.409-4.26-2.409-6.77 0-1.93.462-3.69 1.387-5.3.924-1.6 2.174-2.94 3.75-4a12.915 12.915 0 0 1 5.318-2.06v-.37c-2.561-.47-4.659-1.66-6.296-3.57-1.621-1.91-2.432-4.14-2.432-6.7 0-2.43.735-4.58 2.205-6.48 1.485-1.89 3.508-3.38 6.068-4.48 2.576-1.09 5.508-1.63 8.796-1.63 3.288 0 6.212.54 8.772 1.63 2.576 1.1 4.599 2.59 6.069 4.48 1.484 1.9 2.227 4.05 2.227 6.48 0 2.57-.826 4.82-2.477 6.73-1.637 1.89-3.72 3.07-6.25 3.54v.37c1.939.3 3.697.99 5.272 2.06a11.937 11.937 0 0 1 3.773 4c.939 1.61 1.409 3.37 1.409 5.3 0 2.51-.811 4.77-2.432 6.77-1.621 1.99-3.848 3.56-6.682 4.73-2.818 1.15-6.045 1.73-9.681 1.73Zm0-7.98c1.378 0 2.591-.26 3.636-.77 1.045-.53 1.864-1.27 2.455-2.21.606-.94.909-2 .909-3.18 0-1.21-.303-2.29-.909-3.23-.607-.94-1.44-1.67-2.5-2.2-1.046-.55-2.243-.82-3.591-.82-1.334 0-2.531.27-3.591.82-1.061.53-1.894 1.26-2.5 2.2-.606.94-.909 2.02-.909 3.23 0 1.18.295 2.24.886 3.18.606.93 1.432 1.65 2.477 2.18 1.061.53 2.273.8 3.637.8Zm0-20.34c1.181 0 2.227-.24 3.136-.73a5.336 5.336 0 0 0 2.159-2.02c.53-.87.796-1.84.796-2.93s-.266-2.06-.796-2.89c-.515-.83-1.227-1.48-2.136-1.95-.909-.49-1.962-.73-3.159-.73-1.182 0-2.235.24-3.159.73-.925.47-1.644 1.12-2.16 1.95-.515.83-.772 1.8-.772 2.89s.257 2.06.772 2.93c.531.85 1.258 1.52 2.182 2.02.925.49 1.97.73 3.137.73Z"
	/><path
		role="none"
		fill="#DCD8C9"
		on:pointerdown={() => press(0)}
		d="M358.03 1459.5c66.5 1 70.361 22 70 28.5-.361 6.5-13.5 49-70 47.5s-70.5-38.5-71-47.5 4.5-29.5 71-28.5Z"
	/><path
		fill="#414A3C"
		class="clickthrough"
		d="M357.682 1522.14c-4.061 0-7.561-.97-10.5-2.89-2.94-1.94-5.205-4.72-6.796-8.34-1.591-3.64-2.378-8.01-2.363-13.11.015-5.11.81-9.44 2.386-13 1.591-3.58 3.849-6.3 6.773-8.16 2.939-1.88 6.439-2.82 10.5-2.82 4.06 0 7.56.94 10.5 2.82 2.954 1.86 5.227 4.58 6.818 8.16 1.591 3.57 2.379 7.9 2.364 13 0 5.12-.796 9.5-2.387 13.13-1.591 3.64-3.856 6.42-6.795 8.34-2.924 1.91-6.424 2.87-10.5 2.87Zm0-9.21c2.424 0 4.386-1.23 5.886-3.7 1.5-2.49 2.243-6.3 2.227-11.43 0-3.37-.34-6.14-1.022-8.32-.682-2.2-1.629-3.84-2.841-4.91-1.212-1.08-2.629-1.62-4.25-1.62-2.409 0-4.356 1.22-5.841 3.66-1.485 2.43-2.235 6.16-2.25 11.19-.015 3.4.311 6.23.977 8.47.682 2.25 1.637 3.92 2.864 5.03 1.227 1.09 2.644 1.63 4.25 1.63Z"
	/>
	<path
		fill="#D9D9D9"
		on:pointerdown={call}
		d="M222.72 895.145C231.053 897.604 236.048 917.276 269.033 936.246C302.018 955.215 335 961.89 335 961.89C335 961.89 335 1034.61 335 1035.66C335 1036.71 308.012 1035.66 279.694 1027.58C251.377 1019.5 249.044 1015.43 222.72 997.37C196.396 979.312 165.522 933.435 163.081 927.815C160.639 922.194 214.388 892.686 222.72 895.145Z"
	/>
	<path
		role="none"
		fill="#D9D9D9"
		on:pointerdown={hangup}
		d="M476.28 896.145C467.947 898.604 462.952 918.276 429.967 937.246C396.982 956.215 364 962.89 364 962.89C364 962.89 364 1035.61 364 1036.66C364 1037.71 390.988 1036.66 419.306 1028.58C447.623 1020.5 449.956 1016.43 476.28 998.37C502.604 980.312 533.478 934.435 535.919 928.815C538.361 923.194 484.612 893.686 476.28 896.145Z"
	/>
	<g>
		<path
			fill="#1D5C1C"
			class="clickthrough"
			d="M245.493 950.162C244.816 948.527 243.032 947.657 241.327 948.123L233.593 950.232C232.063 950.654 231 952.043 231 953.625C231 975.369 248.631 993 270.375 993C271.957 993 273.346 991.937 273.768 990.407L275.877 982.673C276.343 980.968 275.473 979.184 273.838 978.507L265.4 974.991C263.968 974.394 262.307 974.807 261.331 976.011L257.78 980.344C251.593 977.417 246.583 972.407 243.656 966.22L247.989 962.678C249.193 961.693 249.606 960.041 249.009 958.608L245.493 950.171V950.162Z"
		/>
	</g>
	<g>
		<path
			fill="#A31E1E"
			class="clickthrough"
			d="M465.895 988.464C467.532 989.135 469.406 988.482 470.277 986.944L474.228 979.968C475.006 978.586 474.77 976.853 473.647 975.738C458.214 960.42 433.281 960.513 417.963 975.946C416.848 977.069 416.625 978.804 417.413 980.181L421.416 987.126C422.298 988.658 424.178 989.297 425.81 988.614L434.249 985.102C435.682 984.506 436.559 983.036 436.392 981.496L435.818 975.923C442.254 973.593 449.339 973.567 455.792 975.848L455.254 981.419C455.104 982.967 455.986 984.424 457.423 985.009L465.889 988.458L465.895 988.464Z"
		/>
	</g>
</svg>

<div class="number">{number}</div>

<style lang="scss">
	svg {
		height: calc(90vh - 30px);
	}

	path.clickthrough {
		pointer-events: none;
	}

	.number {
		font-family: Poxel, monospace;
		text-overflow: ellipsis;
		letter-spacing: -0.2vh;
		word-break: break-all;
		overflow-y: hidden;
		font-size: 3.45vh;
		user-select: none;
		fill: #081b00;
		width: 23.5vh;
		height: 18vh;

		position: absolute;
		margin-left: -12vh;
		top: 30vh;
		left: 50%;
	}
</style>
